<!DOCTYPE html>
<html>
    <head>
        <title>Sensor</title>
        <meta charset="UTF-8">  
        <script>
        window.onload = function () {

            var dataPoints1 = [];
            var dataPoints2 = [];

            var chart = new CanvasJS.Chart("chartContainer", {
                zoomEnabled: true,
                title: {
                    text: "Sensor"
                },
                axisX: {
                    title: "chart updates every 10 secs"
                },
                axisY:{
                    //prefix: "$",
                    includeZero: false
                }, 
                toolTip: {
                    shared: true
                },
                legend: {
                    cursor:"pointer",
                    verticalAlign: "top",
                    fontSize: 22,
                    fontColor: "dimGrey",
                    itemclick : toggleDataSeries
                },
                data: [
                    { 
                        type: "line",
                        xValueType: "dateTime",
                        yValueFormatString: "####.00°C",
                        xValueFormatString: "hh:mm:ss TT",
                        showInLegend: true,
                        name: "Temp",
                        dataPoints: dataPoints1
                    },
                    {               
                        type: "line",
                        xValueType: "dateTime",
                        yValueFormatString: "####.00%",
                        showInLegend: true,
                        name: "Hum" ,
                        dataPoints: dataPoints2
                }]
            });

            function toggleDataSeries(e) {
                if (typeof(e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
                    e.dataSeries.visible = false;
                }
                else {
                    e.dataSeries.visible = true;
                }
                chart.render();
            }

            var updateInterval = 10000;

            let lastPoint = [0,0]
            
            async function updateChart2() {

                const jsondata = await fetch( "/getItems" )
                const data = await jsondata.json()

                data.forEach((point, i) => {

                    const exist = dataPoints1.find( (el) => {
                        return el.x === point.time
                    })

                    if(!exist){

                        // pushing the new values
                        dataPoints1.push({
                            x: point.time,
                            y: point.temp
                        });
                        dataPoints2.push({
                            x: point.time,
                            y: point.hum
                        });
                    }

                })

                // updating legend text with  updated with y Value 
                chart.options.data[0].legendText = " Temp " + dataPoints1[dataPoints1.length-1].y + "°C";
                chart.options.data[1].legendText = " Hum  " + dataPoints2[dataPoints2.length-1].y + "%"; 
                chart.render();
            }

            updateChart2()
            setInterval(function(){updateChart2()}, updateInterval);

        }
        </script>
    </head>
    
    <body>
        <div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
        <script src="js/canvasjs.min.js"></script>
    </body>
</html>